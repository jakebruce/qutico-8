pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
--solaro n-body sim
--by jake and vibha


function _update()
	m=get_mouse()
	
	live_entities={}
 for e in all(entities) do
 	e:update(m)
 	if (e.alive) add(live_entities,e)
 end
 entities=live_entities
 debug=#entities
	update_mode(m)
end


function _draw()
 cls()
 draw_stars()
 for e in all(entities) do
 	e:draw()
 end
 if mode=="vector" then
 	line(vector.x1,vector.y1,
 		vector.x2,vector.y2,8)
 end
	spr(1,m.x,m.y)
	print(debug,0,0,1)
end


function draw_stars()
	for star in all(stars) do
		if rnd()>0.01 then
		 pset(
		 	star.x-sun.x+64,
		 	star.y-sun.y+64,
		 	star.c)
		end
	end
	for star in all(far_stars) do
		if rnd()>0.01 then
			pset(star.x,star.y,star.c)
		end
	end
end


function get_mouse()
	return {
		x=stat(32),
		y=stat(33),
		b=stat(34),
		w=stat(36),
	}
end


function draw_spr(self)
	for p in all(self.p) do
		pset(
			p.x+4-sun.x+64,
			p.y+4-sun.y+64,
			self.c)
	end
	
	spr(rnd(self.n),
		self.x-sun.x+64,
		self.y-sun.y+64,
		1,1,
		rnd()<0.5,
		rnd()<0.5)
end


function noop() end
-->8
--init


function _init()
	--enable keyboard and mouse
	poke(0x5f2d,1)

	dt=0.1
	
	entities={}
	sun=make_sun()
	add(entities,sun)
	
	stars={}
	cs={7,9,10,12}
	for i=1,1600 do
		add(stars,{
			x=rnd()*1280,
			y=rnd()*1280,
			c=rnd(cs)})
	end
	
	far_stars={}
	for i=1,10 do
		add(far_stars,{
			x=rnd()*128,
			y=rnd()*128,
			c=rnd(cs)})
	end
	
	mode="free"
	
	debug=""
	
	music(0)
end
-->8
--entities


function make_sun()
	return {
		x=64,
		y=64,
		vx=0,
		vy=0,
		n={2,3},
		m=6400.0,
		p={},
		immortal=true,
		alive=true,
		update=update_body,
		draw=draw_spr,
	}
end


function make_body(vector)
	return {
		x=vector.x1+sun.x-64,
		y=vector.y1+sun.y-64,
		vx=vector.x2-vector.x1,
		vy=vector.y2-vector.y1,
		n={18},
		m=64,
		p={},
		c=rnd()*15+1,
		alive=true,
		update=update_body,
		draw=draw_spr,
	}
end


function update_body(self,m)
	add(self.p,{x=self.x,y=self.y})
	if #self.p > 500 then
		deli(self.p,1)
	end
			
	for e in all(entities) do
		g=gravity(self,e)
		if g.dead then
		 self.alive=false or self.immortal
			sfx(0)
			add(entities,
				make_explosion(
					self.x,self.y))
		end
		self.vx+=g.x*dt
		self.vy+=g.y*dt
	end
		
	self.x+=self.vx*dt
	self.y+=self.vy*dt
	
	if self.x-sun.x+64<-800 or self.x-sun.x+64>1280
	or self.y-sun.y+64<-800 or self.y-sun.y+64>1280
	then
		self.alive=false or self.immortal
	end
	
end


function gravity(self,other)
	if (self==other or other.m<=0) return {x=0,y=0,dead=false}
 
 --vector to the other
	dsx=other.x-self.x
	dsy=other.y-self.y
			
	--very distant objects dont count
	if abs(dsx) > 128
	or abs(dsy) > 128 then
		ds=max(abs(dsx),abs(dsy))
	else
		--distance to the other
		ds=sqrt(dsx*dsx+dsy*dsy)
	end
	
	if (ds<=0) return {x=0,y=0,dead=false}
			
	--we dead?
	if (ds<2) return {x=0,y=0,dead=true}
			
	--unit vector to the other
	usx=dsx/ds
	usy=dsy/ds
			
	--force to the other
	fs=1/(ds*ds)*other.m
			
	--acceleration to the other
	dvx=fs*usx
	dvy=fs*usy
	
	return {x=dvx,y=dvy,dead=false}
end


function make_explosion(x,y)
	return {
		x=x,
		y=y,
		t=0,
		l=30,
		m=0,
		n={7,8,9,10},
		alive=true,
		update=function(self,m)
			self.t+=1
			if (self.t>self.l) self.alive=false
		end,
		draw=function(self)
			n=self.n[self.t%#self.n]
			fx=rnd()<0.5
			fy=rnd()<0.5
			spr(n,
				self.x-sun.x+64,
				self.y-sun.y+64,
				1,1,fx,fy)
		end,
	}
end
-->8
--gameplay code


function update_mode(m)
 if mode=="free" and m.b==1 then
 	mode="vector"
 	vector={
 		x1=m.x,
 		y1=m.y,
 		x2=m.x,
 		y2=m.y}

 elseif mode=="vector" and m.b!=1 then
 	mode="free"
 	add(entities,make_body(vector))

 elseif mode=="vector" then
		vector.x2=m.x
		vector.y2=m.y
 end
end

__gfx__
000000005000000000aaaa0000aa9a000000000000000000000000000000000000000000000900000aa9aa000000000000000000000000000000000000000000
0000000065000000aa999aa00a999a0000000000000000000000000000000000aa0a0000aa099000aa8000700000000000000000000000000000000000000000
0070070066500000aa99999aaa99999a000000000000000000000000099599000a9a99000a9a99000a9a29770000000000000000000000000000000000000000
0007700066650000a998899aa998899a000000000000000000000000045595000a522aa000828aa00a0a2a070000000000000000000000000000000000000000
0007700000600000a998899aa998999a00000000000000000000000009225500095525000980050002090aaa0000000000000000000000000000000000000000
0070070000000000a99999aaa999999a000000000000000000000000099549000995a90002282900022200700000000000000000000000000000000000000000
00000000000000000a9a99a00a9a99a0000000000000000000000000009000000090a0000a999000779907700000000000000000000000000000000000000000
000000000000000000aaaa00000aaa00000000000000000000000000000000000000000000009000009090700000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000055400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000455550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000455550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000055440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
11100000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000000000000000000000000000f0000000000000000100000000000000a0000000900000000000000000000000000000000000000000000000000000000
00100000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000000000000000000000000000f000000000000000000100000000000000000000000000000000000000000000000000000000000000000000007000000
0010000000000000000000000000000000000000000000000001000000000000000c000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000f000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000a0000000f0000000000000000000000100000000000a0000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000f000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000f0000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000b
00000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000f000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000b0
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b00
00000000000000000000000000000000f00000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000b000
00000000000000000000000000000000f00000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000b0000
000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000b00000
0000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000b000000
000000000000000000000000000000000f0000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b0000000
000000000000000000000000000000000f0000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000b00000000
0000000000000000000000000000000000f000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000a00000000000000000000001000000000000000c000000000000000000000000000000000b000000000
0000000000000000000000000000000000f000000000000000000000000000000000090000000007000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000b0000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b00000000000
0000000000000000000000000000000000f000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000c00000000000000000000000000000000100000000000070000000000000000000000000000000b000000000000
00000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000b00000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000b000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000b0000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000b00000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000b000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000f0000000000000000000000000000000000010000000000000000000000000000000000b0000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b00000000000000000000
00000000000000000000000000000000000000f00000000000000000000000000000000001000000000000000000000000000000000000000000000000000003
000000000000000000000000000000000000000000000000000000020020200000000000000000000000000000000000000000000b0000000000000000000300
00000000000000000000000000000000000000f00000000000020200000000020000000000000000000000000000000000000000000000000000000000030000
00000000000000000000000000000000000000000000000202000000000000000200000001000000000000000000000000000000b00000000000000000000000
00000000000000000000000000000000000000000000002000000000000000000000200000000000000000000000000000000000000000000000000000300000
000000000000000000000000000000000000000f000020000000000000000000000000001000000000000000000000000000000b00000000000000a030000000
00000000000000000000000000000000000000000020000000000000020020200000002000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000f200000000000202000000000202000000000000000000000000000000000b00000000000000003000000000
00000000000070000000000000000000000000002000000000020000000000000000000020000000000000000000000000000000000000000000300000000000
0000000000000000000000000000000000000002000000002200000000000000000000200000000000000000000000000000b000000000000030000000000000
00000090000000000000000000000000000000200f000020000000000000000000000000202000000000000000000000000b0000000000000000000000000000
00000000000000000000000000000000000002000000020000000000000000000000001000000000000000000000000000000000000000003000000000000000
000000000000000000000000000000000000200000020000000000000000000000000000000000000000000000000a000b000000000000300000000000000000
00000000000000000000000000000000000200000020000000000000000000000000000000020000000000000000000000000000000000000000000000000000
000000000000000000000000000000000020000002000000000000000000000000000100000000000000000000000000b0000000000030000000000000000000
00000000000000000000000000000000020000002000f00000000000000000000000000000002000000000000000000000000000003000000000000000000000
0000000000000000000000000000000020000002000000000000000000000000000100000000200000000000000000b000000000300000000000000000000000
000000000000000000000000000000002000002000000000000000000000000000aaa00000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000020000020000000f0000000000000000000199a9a0000022000000000000000b0000000030000000000000000000000000
0000000000000000000000000000000200002000000000000000000000000000a999999a00000000000000000000000000003000000000000000000000000000
0000000000000000000000000000002000002000000000000000000000000001a999899a0000000000000000000b000000300000000000000000000000000000
00000000000000000000000000000020000200000000000f0000000000001000a998899a00002020000000000000000000000000000000000000000000000000
0000000000000000000000000000002000000000000000000000000000000000a99999aa00000000000000000b00000030000000000000000000000000000000
0000000000000000000000000000020000200000000000000f0000010010000000a999a0000020200000000b0000003000000000000000000000000000000000
000000000000000000000000000002000020000000000000000001000000000000a9aa0000000000000000000000300000000000000000000000000000000000
000000000000000000000000000002000200010101010010101f0000000000000000000000000000000000b00000000000000000000000000000000000000000
00000000000000000000000000000200020000000000000000000000000000000000000000020020000000000300000000000000000000000000000000000000
00000000000000000000000000002000a20000000000000000000f000000000000000000000000000000b0030000000000000000000000000000000000000000
0000000000000000000000000000200020a000000000000000000000000000000000000000020020000003000000000000000000000000000000000000000000
00000000000000000000000000002044550000000000000000000000f0000000000000000000000000b000000000000000000000000000000000000000000000
000000000000000000700000000020555540a0000000000000000000000000000000000000200000b00000000000000000000000000000000000000000000000
000000000000000000000000000020555540000a000000000000000000f000000000000000000200000000000000000000000000000000000000000000000000
00000000000000000000000000002004550000000a000000000000000000000000000000020000b0000000000000000000000000000000000000000000000000
000000000000000000000000000020000000000000000000000000000000f0000000000020032000000000000000000000000000000000000000000000000000
0000000000000000000000000000020000000000000a0000000000000000000f0000000003000000000000000000000000000000000000000000000000000000
0000000000000000000000000000020000000000000000a000000000000000000003003200b200000000000000000000c0000000000000000000000000000000
000000000000000000000000000002000000000000000000a0000000000000000f00002b00200000000000000000000000000000000000000000000000000000
000000000000000000000000000002000000000000000000000a000000000030000f000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000020000000000000000000000a0c0300300000002bf002000000000000000000000000000000000000000000000000000000
00000000000000000000000000000020000000000000000000003030a00000000002000020000000000000000000000000000000000000000000000000000000
00000000000000000000000000000002000000000000003003000000000a00000b20000000f00000000000000000000000000000000000000000000000000000
0000000000000000000000000000000200003003030030000000007000000a0b020000020000f000000000000000000000000000000000000000000000000000
000000000000000000000000000000002000000000000000000000000000000020a000200000000f000000000000000000000000000000000000000000000000
000000000000000000000000000000002200000000000000000000000000b22000002a00000000000f0000000000000000000000000000000000000000000000
0000000000000000000000000000c00002200000000000000000000000b000000002000a00a00000000f00000000000000000000000000000000000000000000
00000000000000000000000000000000000200000000000000000000b0000000002000000000a00a00000f000000000000000000000000000000000000000000
000000000000000000000000000000000000220000000000000b00b00000000202000000000000000a00a00f0000000000000000000000000000000000000000
0000000000000000000000000000000000000220000000000b000000000000200000000000000000000000a00f0a000000000000000000000000000000000000
00000000000000000000000000000000000000022000000b000000000000220000000000000000000000000000000a00a0000000000000000000000000000000
00000000000000000000000000000000000000000222000000000000222000000000000000000000000000000000000000a0a00a000000000000000000000000
000000000000000000000000000000000000000000002222222222220000000000000000000000000000000000000000000000000a0a00a0a000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00a0a0a000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00a0
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
00060000326102f6102e6102d6102a6102761025610216101f6101d6101d6101d6201d6201c6201b6301b6301a6301a630156401466013660116400e6400d6400c6400c6300c6200b6100a610096100861004610
001000010002004100041000510005100061000710006100061000510003100031000310003100031000310003100011000010000100001000010000100051000410003100031000210002100021000010000100
012000000005300003000030000300053000030000300003000530000300003000032461500003000030000300053000030000300003000530000300003000030005300003000030000324615000030000300003
00200000185151c5151c5151c5151a515185151a5151c5151d5151d5151d5151c5151d5151f515215151d5151c5151c5151c5151f515215151f5151c5151f5151a5151a5151a5151a5151a5151a5151a5151a515
01200000185120050200502185120050218512005020050200502005021851200502005021a512005021a512005021a512005021a512005020050200502005021c512005021c512005021d512005021c51200502
__music__
03 01020304

